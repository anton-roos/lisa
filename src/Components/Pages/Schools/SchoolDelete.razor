@page "/schools/delete/{id:guid?}"
@using Lisa.Models.Entities
@inject SchoolService SchoolService
@inject NavigationManager NavigationManager
@inject IDialogService DialogService

<PageTitle>Confirm School Delete</PageTitle>
<h2>Confirm School Delete</h2>

<AuthorizeView Roles="@Roles.SystemAdministrator">
    <Authorized>
        @if (School != null)
        {
            <div class="alert alert-warning">
                <p>
                    <MudIcon Icon="Icons.Material.Filled.Warning" Color="Color.Warning" Class="me-2" />
                    Are you sure you want to delete the school
                    <strong>@School.ShortName</strong>?
                </p>
                <p>This will delete the record. Once deleted, this can not be rolled back.</p>
                <p>This will delete the <strong>Principal</strong> and all <strong>Staff</strong> along with all
                    <strong>Learners</strong> and <strong>Subject Combinations</strong> belonging to this School.
                </p>
                <p>This School has:</p>
                <ul>
                    <li>
                        @if (School.Staff != null)
                        {
                            @School.Staff.Count
                        }
                        Staff
                    </li>
                    <li>
                        @if (School.Learners != null)
                        {
                            @School.Learners.Count
                        }
                        Learners
                    </li>
                    <li>
                        @if (School.RegisterClasses != null)
                        {
                            @School.RegisterClasses.Count
                        }
                        Register Classes
                    </li>
                </ul>
                <p>Do you want to proceed?</p>
            </div>

            <div class="d-flex justify-content-between">
                <button class="btn btn-danger" @onclick="DeleteSchool">Delete</button>
                <button class="btn btn-secondary">Cancel</button>
            </div>
        }
    </Authorized>
    <NotAuthorized>
        <Unauthorized/>
    </NotAuthorized>
</AuthorizeView>


@code
{
    [Parameter] public Guid? Id { get; set; }
    private School? School { get; set; }
    private Exception _exception = new();

    protected override async Task OnInitializedAsync()
    {
        if (Id.HasValue)
        {
            School = await SchoolService.GetSchoolAsync(Id.Value);
        }
    }

    private async Task DeleteSchool()
    {
        if (School != null)
        {
            try
            {
                var schoolToDelete = await SchoolService.GetSchoolAsync(School.Id);

                if (schoolToDelete == null)
                {
                    throw new Exception("School not found.");
                }

                await SchoolService.DeleteSchoolAsync(School);
                NavigationManager.NavigateTo("/schools");
            }
            catch (Exception ex)
            {
                _exception = ex;
                await ShowErrorDialog();
            }
        }
    }

    private async Task ShowErrorDialog()
    {
        var options = new DialogOptions()
        {
            CloseButton = true,
            MaxWidth = MaxWidth.Medium,
            FullWidth = true
        };

        await DialogService.ShowMessageBox(
            title: "Error",
            message: $"You can't delete this school because of the following: {_exception.Message}",
            yesText: "Ok",
            options: options);
    }
}
