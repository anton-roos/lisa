@using Lisa.Models.Entities
@using Lisa.Services
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@inject SchoolService SchoolService
@inject SchoolGradeService SchoolGradeService
@inject SubjectService SubjectService
@inject UserService UserService
@inject AuthenticationStateProvider AuthStateProvider
@inject ILogger<PlanSelector> Logger

<div class="card p-3 mb-3">
    <h5 class="mb-3">Plan Context</h5>

    <div class="row g-3">
        @if (IsSystemAdministrator)
        {
            <div class="col-md-2">
                <label class="form-label">School</label>
                @if (IsReadOnly && selectedSchoolId.HasValue)
                {
                    var selectedSchool = Schools.FirstOrDefault(s => s.Id == selectedSchoolId.Value);
                    <input type="text" class="form-control" value="@(selectedSchool?.LongName ?? "Loading...")" readonly />
                }
                else
                {
                    <select class="form-select" @bind="selectedSchoolId" @bind:after="OnSchoolChanged" disabled="@IsReadOnly">
                        <option value="">-- Select School --</option>
                        @foreach (var school in Schools)
                        {
                            <option value="@school.Id">@school.LongName</option>
                        }
                    </select>
                }
            </div>
        }
        else if (CurrentSchool != null)
        {
            <div class="col-md-2">
                <label class="form-label">School</label>
                <input type="text" class="form-control" value="@CurrentSchool.LongName" readonly />
            </div>
        }

        <div class="col-md-2">
            <label class="form-label">Year</label>
            @if (IsReadOnly && selectedAcademicYearId.HasValue)
            {
                var selectedYear = AcademicYears.FirstOrDefault(y => y.Id == selectedAcademicYearId.Value);
                <input type="text" class="form-control" value="@(selectedYear != null ? $"{selectedYear.Year} {(selectedYear.IsCurrent ? "(Current)" : "")}" : "Loading...")" readonly />
            }
            else
            {
                <select class="form-select" @bind="selectedAcademicYearId" disabled="@(!selectedSchoolId.HasValue || IsReadOnly)" @bind:after="OnYearChanged">
                    <option value="">-- Select Year --</option>
                    @foreach (var year in AcademicYears.OrderByDescending(y => y.Year))
                    {
                        var isSelected = selectedAcademicYearId == null && (
                            year.Year == DateTime.UtcNow.Year || 
                            (year.IsCurrent && AcademicYears.All(y => y.Year != DateTime.UtcNow.Year))
                        );
                        <option value="@year.Id" selected="@isSelected">@year.Year @(year.IsCurrent ? "(Current)" : "")</option>
                    }
                </select>
            }
        </div>

        <div class="col-md-2">
            <label class="form-label">Grade</label>
            @if (IsReadOnly && selectedSchoolGradeId.HasValue)
            {
                var selectedGrade = SchoolGrades.FirstOrDefault(g => g.Id == selectedSchoolGradeId.Value);
                <input type="text" class="form-control" value="@(selectedGrade?.SystemGrade?.Name ?? "Loading...")" readonly />
            }
            else
            {
                <select class="form-select" @bind="selectedSchoolGradeId" disabled="@(!selectedSchoolId.HasValue || !selectedAcademicYearId.HasValue || IsReadOnly)" @bind:after="OnGradeChanged">
                    <option value="">-- Select Grade --</option>
                    @foreach (var grade in SchoolGrades)
                    {
                        <option value="@grade.Id">@grade.SystemGrade?.Name</option>
                    }
                </select>
            }
        </div>

        <div class="col-md-2">
            <label class="form-label">Subject</label>
            @if (IsReadOnly && selectedSubjectId.HasValue)
            {
                var selectedSubject = Subjects.FirstOrDefault(s => s.Id == selectedSubjectId.Value);
                <input type="text" class="form-control" value="@(selectedSubject?.Name ?? "Loading...")" readonly />
            }
            else
            {
                <select class="form-select" @bind="selectedSubjectId" disabled="@(!selectedSchoolGradeId.HasValue || IsReadOnly)" @bind:after="OnSubjectChanged">
                    <option value="">-- Select Subject --</option>
                    @foreach (var subject in Subjects)
                    {
                        <option value="@subject.Id">@subject.Name</option>
                    }
                </select>
            }
        </div>

        <div class="col-md-2">
            <label class="form-label">Term</label>
            @if (IsReadOnly && selectedTerm.HasValue)
            {
                <input type="text" class="form-control" value="@($"Term {selectedTerm.Value}")" readonly />
            }
            else
            {
                <select class="form-select" @bind="selectedTerm" disabled="@(!selectedSubjectId.HasValue || IsReadOnly)" @bind:after="OnTermChanged">
                    <option value="">-- Select Term --</option>
                    <option value="1">Term 1</option>
                    <option value="2">Term 2</option>
                    <option value="3">Term 3</option>
                    <option value="4">Term 4</option>
                </select>
            }
        </div>
    </div>
</div>

@code {
    [Parameter] public EventCallback<SelectionResult> OnChanged { get; set; }
    [Parameter] public SelectionResult? InitialSelection { get; set; }
    [Parameter] public bool IsReadOnly { get; set; } = false;

    private List<School> Schools = new();
    private List<SchoolGrade> SchoolGrades = new();
    private ICollection<Subject> Subjects = new List<Subject>();
    private List<AcademicYear> AcademicYears = new();

    private Guid? selectedSchoolId;
    private Guid? selectedAcademicYearId;
    private Guid? selectedSchoolGradeId;
    private int? selectedSubjectId;
    private int? selectedTerm;

    private bool IsSystemAdministrator { get; set; } = false;
    private School? CurrentSchool { get; set; }

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // Get current user and check if system administrator
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;
            IsSystemAdministrator = user.IsInRole(Data.Roles.SystemAdministrator);

            if (IsSystemAdministrator)
            {
                // Load all schools for system administrators
                Schools = await SchoolService.GetAllSchoolsAsync();
            }
            else
            {
                // Auto-assign school for teachers/principals
                CurrentSchool = await SchoolService.GetSelectedSchoolAsync();
                if (CurrentSchool != null)
                {
                    selectedSchoolId = CurrentSchool.Id;
                    await LoadAcademicYearsAsync();
                    await LoadGradesAsync(); // Load grades when school is auto-assigned
                    
                    // Set default year: prefer current year (2026), then IsCurrent flag, then most recent
                    var currentYearValue = DateTime.UtcNow.Year; // This will be 2026
                    var preferredYear = AcademicYears.FirstOrDefault(y => y.Year == currentYearValue)
                        ?? AcademicYears.FirstOrDefault(y => y.IsCurrent)
                        ?? AcademicYears.OrderByDescending(y => y.Year).FirstOrDefault();
                    
                    if (preferredYear != null)
                    {
                        selectedAcademicYearId = preferredYear.Id;
                        await OnYearChanged();
                    }
                }
                else
                {
                    Logger.LogWarning("Non-system administrator user does not have an associated school.");
                }
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error initializing PlanSelector");
        }

        // If initial selection is provided (e.g., when loading an existing plan), populate the fields
        if (InitialSelection != null)
        {
            await LoadInitialSelectionAsync();
        }
    }

    protected override async Task OnParametersSetAsync()
    {
        // Reload initial selection if it changes
        if (InitialSelection != null)
        {
            await LoadInitialSelectionAsync();
        }
        await base.OnParametersSetAsync();
    }

    private async Task LoadInitialSelectionAsync()
    {
        if (InitialSelection == null) return;

        try
        {
            // Set school first
            if (InitialSelection.SchoolId.HasValue)
            {
                selectedSchoolId = InitialSelection.SchoolId.Value;
                
                // Load schools if not already loaded (for System Admins)
                if (IsSystemAdministrator && Schools.Count == 0)
                {
                    Schools = await SchoolService.GetAllSchoolsAsync();
                }
                
                // Load academic years for the school
                await LoadAcademicYearsAsync();
            }

            // Set academic year
            if (InitialSelection.AcademicYearId.HasValue)
            {
                selectedAcademicYearId = InitialSelection.AcademicYearId.Value;
                await LoadGradesAsync(); // Load grades when year is set
            }

            // Set school grade
            if (InitialSelection.SchoolGradeId.HasValue)
            {
                selectedSchoolGradeId = InitialSelection.SchoolGradeId.Value;
                await LoadSubjectsAsync(); // Load subjects when grade is set
            }

            // Set subject
            if (InitialSelection.SubjectId.HasValue)
            {
                selectedSubjectId = InitialSelection.SubjectId.Value;
            }

            // Set term
            if (InitialSelection.Term.HasValue)
            {
                selectedTerm = InitialSelection.Term.Value;
            }

            // Notify parent of the loaded selection
            await NotifyParentAsync();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading initial selection in PlanSelector");
        }
    }

    private async Task OnSchoolChanged()
    {
        selectedAcademicYearId = null;
        selectedSchoolGradeId = null;
        selectedSubjectId = null;
        selectedTerm = null;

        if (selectedSchoolId.HasValue)
        {
            await LoadAcademicYearsAsync();
            await LoadGradesAsync();
        }
        else
        {
            AcademicYears.Clear();
            SchoolGrades.Clear();
            Subjects.Clear();
        }

        await NotifyParentAsync();
    }

    private async Task OnYearChanged()
    {
        // When year changes, ensure grades are loaded if not already loaded
        if (selectedSchoolId.HasValue && SchoolGrades.Count == 0)
        {
            await LoadGradesAsync();
        }
        await NotifyParentAsync();
    }

    private async Task OnGradeChanged()
    {
        selectedSubjectId = null;
        selectedTerm = null;

        await LoadSubjectsAsync();
    }

    private async Task OnSubjectChanged()
    {
        selectedTerm = null;
        await NotifyParentAsync();
    }

    private async Task OnTermChanged()
    {
        await NotifyParentAsync();
    }

    private async Task LoadAcademicYearsAsync()
    {
        if (selectedSchoolId.HasValue)
        {
            AcademicYears = await SchoolService.GetAcademicYearsForSchoolAsync(selectedSchoolId.Value);
            
            // Ensure current year (2026) exists - create it if it doesn't
            var currentYearValue = DateTime.UtcNow.Year;
            if (!AcademicYears.Any(y => y.Year == currentYearValue))
            {
                try
                {
                    var newYear = await SchoolService.AddAcademicYearAsync(selectedSchoolId.Value, currentYearValue);
                    if (newYear != null)
                    {
                        AcademicYears.Add(newYear);
                        AcademicYears = AcademicYears.OrderByDescending(y => y.Year).ToList();
                    }
                }
                catch (Exception ex)
                {
                    Logger.LogError(ex, "Failed to create academic year {Year} for school {SchoolId}", currentYearValue, selectedSchoolId.Value);
                }
            }
        }
        else
        {
            AcademicYears.Clear();
        }
    }

    private async Task LoadGradesAsync()
    {
        if (selectedSchoolId.HasValue)
        {
            SchoolGrades = await SchoolGradeService.GetGradesForSchool(selectedSchoolId.Value);
        }
        else
        {
            SchoolGrades = new();
        }

        Subjects.Clear();
        await NotifyParentAsync();
    }

    private async Task LoadSubjectsAsync()
    {
        if (selectedSchoolGradeId.HasValue)
        {
            Subjects = await SubjectService.GetSubjectsForGradeAsync(selectedSchoolGradeId.Value);
        }
        else
        {
            Subjects = new List<Subject>();
        }

        await NotifyParentAsync();
    }

    private async Task NotifyParentAsync()
    {
        await OnChanged.InvokeAsync(new SelectionResult
        {
            SchoolId = selectedSchoolId,
            AcademicYearId = selectedAcademicYearId,
            SchoolGradeId = selectedSchoolGradeId,
            SubjectId = selectedSubjectId,
            Term = selectedTerm
        });
    }

    public class SelectionResult
    {
        public Guid? SchoolId { get; set; }
        public Guid? AcademicYearId { get; set; }
        public Guid? SchoolGradeId { get; set; }
        public int? SubjectId { get; set; }
        public int? Term { get; set; }
    }
}