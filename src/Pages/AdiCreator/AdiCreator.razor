@page "/adi-creator"
@using Lisa.Data
@using Lisa.Enums
@using Lisa.Models.Entities
@using System.Security.Claims
@using MudBlazor
@inject SchoolService SchoolService
@inject SchoolGradeService SchoolGradeService
@inject SubjectService SubjectService
@inject UserService UserService
@inject LearnerService LearnerService
@inject AcademicDevelopmentClassService AdiService
@inject AdiAttendanceService AdiAttendanceService
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager Navigation
@inject ILogger<AdiCreator> Logger
@inject IDialogService DialogService
@inherits EventAwareComponentBase

<PageTitle>ADI Creator</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudText Typo="Typo.h4" Class="mb-3">ADI Creator</MudText>

    @if (_selectedSchool == null)
    {
        <NoSchoolSelected Message="Please select a school from the dropdown at the top of the page before proceeding." />
    }
    else
    {
        <MudPaper Class="pa-4 mb-4">
            <MudText Typo="Typo.h6" Class="mb-3">Create Academic Development Intervention (ADI)</MudText>

            <MudGrid>
                <MudItem xs="12" sm="6" md="3">
                    <MudSelect T="AdiType" Label="ADI Type" Variant="Variant.Outlined" Required="true"
                               Value="_adiModel.AdiType" ValueChanged="OnAdiTypeChanged">
                        <MudSelectItem T="AdiType" Value="AdiType.Support">Support (Grade-focused)</MudSelectItem>
                        <MudSelectItem T="AdiType" Value="AdiType.Break">Break (Multi-grade)</MudSelectItem>
                    </MudSelect>
                </MudItem>

                @if (_adiModel.AdiType == AdiType.Support)
                {
                    <MudItem xs="12" sm="6" md="3">
                        <MudSelect T="Guid?" Label="Grade" Variant="Variant.Outlined" Required="true"
                                   Value="_adiModel.SchoolGradeId" ValueChanged="OnGradeChanged"
                                   Error="@_validationErrors.ContainsKey("Grade")" ErrorText="@(_validationErrors.GetValueOrDefault("Grade"))">
                            <MudSelectItem T="Guid?" Value="@((Guid?)null)">-- Select Grade --</MudSelectItem>
                            @foreach (var grade in _schoolGrades.OrderBy(g => g.SystemGrade.SequenceNumber))
                            {
                                <MudSelectItem T="Guid?" Value="@grade.Id">@grade.SystemGrade.Name</MudSelectItem>
                            }
                        </MudSelect>
                    </MudItem>

                    <MudItem xs="12" sm="6" md="3">
                        <MudSelect T="int?" Label="Subject" Variant="Variant.Outlined" Required="true"
                                   Value="_adiModel.SubjectId" ValueChanged="OnSubjectChanged"
                                   Error="@_validationErrors.ContainsKey("Subject")" ErrorText="@(_validationErrors.GetValueOrDefault("Subject"))">
                            <MudSelectItem T="int?" Value="@((int?)null)">-- Select Subject --</MudSelectItem>
                            @foreach (var subject in _availableSubjects.OrderBy(s => s.Name))
                            {
                                <MudSelectItem T="int?" Value="@subject.Id">@subject.Name</MudSelectItem>
                            }
                        </MudSelect>
                    </MudItem>
                }

                @* Break ADI - Multi-select subjects *@
                @if (_adiModel.AdiType == AdiType.Break)
                {
                    <MudItem xs="12">
                        <MudText Typo="Typo.subtitle2" Color="Color.Secondary" Class="mb-2">
                            Select Subjects (Multi-select)
                        </MudText>
                        <MudChipSet T="string" Class="mb-2" SelectionMode="SelectionMode.MultiSelection">
                            @foreach (var subject in _availableSubjects.OrderBy(s => s.Name))
                            {
                                var isSelected = _selectedBreakSubjectIds.Contains(subject.Id);
                                <MudChip T="string"
                                         Color="@(isSelected ? Color.Primary : Color.Default)"
                                         Variant="@(isSelected ? MudBlazor.Variant.Filled : MudBlazor.Variant.Outlined)"
                                         Style="@(isSelected ? "font-weight: bold;" : "")"
                                         OnClick="@(() => ToggleBreakSubject(subject.Id))">
                                    @if (isSelected)
                                    {
                                        <MudIcon Icon="@Icons.Material.Filled.Check" Size="Size.Small" Class="me-1" />
                                    }
                                    @subject.Name
                                </MudChip>
                            }
                        </MudChipSet>
                        @if (_validationErrors.ContainsKey("Subjects"))
                        {
                            <MudText Typo="Typo.caption" Color="Color.Error">@_validationErrors["Subjects"]</MudText>
                        }
                    </MudItem>
                }

                <MudItem xs="12" sm="6" md="3">
                    <MudDatePicker Label="Date" Variant="Variant.Outlined" Required="true"
                                   @bind-Date="_selectedDate"
                                   Error="@_validationErrors.ContainsKey("DateTime")" ErrorText="@(_validationErrors.GetValueOrDefault("DateTime"))" />
                </MudItem>

                <MudItem xs="12" sm="6" md="3">
                    <MudTimePicker Label="Time" Variant="Variant.Outlined" Required="true"
                                   @bind-Time="_selectedTime" />
                </MudItem>

                @* Support ADI - Single teacher selection *@
                @if (_adiModel.AdiType == AdiType.Support)
                {
                    <MudItem xs="12" sm="6">
                        <MudSelect T="Guid?" Label="Teacher" Variant="Variant.Outlined"
                                   Value="_adiModel.TeacherId" ValueChanged="OnTeacherChanged">
                            <MudSelectItem T="Guid?" Value="@((Guid?)null)">-- Select Teacher --</MudSelectItem>
                            @foreach (var teacher in _availableTeachers.OrderBy(t => t.Surname).ThenBy(t => t.Name))
                            {
                                <MudSelectItem T="Guid?" Value="@teacher.Id">@teacher.Surname, @teacher.Name</MudSelectItem>
                            }
                        </MudSelect>
                    </MudItem>
                }

                @* Break ADI - Multi-select teachers *@
                @if (_adiModel.AdiType == AdiType.Break)
                {
                    <MudItem xs="12">
                        <MudText Typo="Typo.subtitle2" Color="Color.Secondary" Class="mb-2">
                            Select Teachers (Multi-select)
                        </MudText>
                        <MudChipSet T="string" Class="mb-2" SelectionMode="SelectionMode.MultiSelection">
                            @foreach (var teacher in _availableTeachers.OrderBy(t => t.Surname).ThenBy(t => t.Name))
                            {
                                var isSelected = _selectedBreakTeacherIds.Contains(teacher.Id);
                                <MudChip T="string"
                                         Color="@(isSelected ? Color.Tertiary : Color.Default)"
                                         Variant="@(isSelected ? MudBlazor.Variant.Filled : MudBlazor.Variant.Outlined)"
                                         Style="@(isSelected ? "font-weight: bold;" : "")"
                                         OnClick="@(() => ToggleBreakTeacher(teacher.Id))">
                                    @if (isSelected)
                                    {
                                        <MudIcon Icon="@Icons.Material.Filled.Check" Size="Size.Small" Class="me-1" />
                                    }
                                    @teacher.Surname, @teacher.Name
                                </MudChip>
                            }
                        </MudChipSet>
                        @if (_validationErrors.ContainsKey("Teachers"))
                        {
                            <MudText Typo="Typo.caption" Color="Color.Error">@_validationErrors["Teachers"]</MudText>
                        }
                    </MudItem>
                }
            </MudGrid>
        </MudPaper>

        @* Learner Selection Section - Show for Support ADI with grade+subject OR Break ADI with at least one subject *@
        @if ((_adiModel.AdiType == AdiType.Support && _adiModel.SchoolGradeId != null && _adiModel.SubjectId != null) ||
             (_adiModel.AdiType == AdiType.Break && _selectedBreakSubjectIds.Count > 0))
        {
            <MudPaper Class="pa-4 mb-4">
                <MudText Typo="Typo.h6" Class="mb-3">Select Learners</MudText>

                @* Auto-selected learners from grade/subject (only for Support ADI) *@
                @if (_adiModel.AdiType == AdiType.Support && _gradeSubjectLearners.Any())
                {
                    <MudText Typo="Typo.subtitle2" Color="Color.Secondary" Class="mb-2">
                        Learners in @(_schoolGrades.FirstOrDefault(g => g.Id == _adiModel.SchoolGradeId)?.SystemGrade?.Name) 
                        taking @(_availableSubjects.FirstOrDefault(s => s.Id == _adiModel.SubjectId)?.Name)
                    </MudText>

                    <MudChipSet T="string" Class="mb-3">
                        @foreach (var learner in _gradeSubjectLearners.Take(20))
                        {
                            var isSelected = _selectedLearnerIds.Contains(learner.Id);
                            <MudChip T="string" 
                                     Color="@(isSelected ? Color.Success : Color.Default)"
                                     Variant="@(isSelected ? MudBlazor.Variant.Filled : MudBlazor.Variant.Outlined)"
                                     Style="@(isSelected ? "font-weight: bold; box-shadow: 0 2px 8px rgba(76, 175, 80, 0.4);" : "")"
                                     OnClick="@(() => ToggleLearner(learner.Id))">
                                @if (isSelected)
                                {
                                    <MudIcon Icon="@Icons.Material.Filled.Check" Size="Size.Small" Class="me-1" />
                                }
                                @learner.DisplayName
                            </MudChip>
                        }
                        @if (_gradeSubjectLearners.Count > 20)
                        {
                            <MudChip T="string" Color="Color.Info" Variant="MudBlazor.Variant.Text">
                                +@(_gradeSubjectLearners.Count - 20) more
                            </MudChip>
                        }
                    </MudChipSet>

                    <MudButton Variant="MudBlazor.Variant.Text" Color="Color.Primary" Size="Size.Small"
                               OnClick="SelectAllGradeSubjectLearners" Class="mb-2">
                        <MudIcon Icon="@Icons.Material.Filled.SelectAll" Class="me-1" Size="Size.Small" />
                        Select All (@_gradeSubjectLearners.Count)
                    </MudButton>
                    <MudButton Variant="MudBlazor.Variant.Text" Color="Color.Secondary" Size="Size.Small"
                               OnClick="DeselectAllGradeSubjectLearners" Class="mb-2 ms-2">
                        <MudIcon Icon="@Icons.Material.Filled.Deselect" Class="me-1" Size="Size.Small" />
                        Deselect All
                    </MudButton>

                    <MudDivider Class="my-3" />

                    @* Search for additional learners (Support ADI) *@
                    <MudText Typo="Typo.subtitle2" Color="Color.Secondary" Class="mb-2">Add Additional Learners from School</MudText>
                    <MudAutocomplete T="Learner" Label="Search learners..." Variant="Variant.Outlined"
                                     SearchFunc="SearchLearnersAsync" ToStringFunc="@(l => l?.DisplayName ?? "")"
                                     ValueChanged="OnAdditionalLearnerSelected" ResetValueOnEmptyText="true"
                                     @ref="_learnerAutocomplete"
                                     Class="mb-2" />
                }

                @* Break ADI - Full learner list with filters *@
                @if (_adiModel.AdiType == AdiType.Break)
                {
                    <MudText Typo="Typo.subtitle2" Color="Color.Secondary" Class="mb-2">
                        Add Learners from any grade - A reason is required for each learner
                    </MudText>

                    @* Filters *@
                    <MudGrid Class="mb-3">
                        <MudItem xs="12" sm="6" md="3">
                            <MudSelect T="string" Label="Filter by Grade" @bind-Value="_breakFilterGradeId"
                                       Variant="Variant.Outlined" Clearable="true" AnchorOrigin="Origin.BottomCenter">
                                <MudSelectItem T="string" Value="@string.Empty">All Grades</MudSelectItem>
                                @foreach (var grade in _schoolGrades.OrderBy(g => g.SystemGrade.SequenceNumber))
                                {
                                    <MudSelectItem T="string" Value="@grade.Id.ToString()">@grade.SystemGrade.Name</MudSelectItem>
                                }
                            </MudSelect>
                        </MudItem>
                        <MudItem xs="12" sm="6" md="3">
                            <MudSelect T="string" Label="Filter by Register Class" @bind-Value="_breakFilterRegisterClassId"
                                       Variant="Variant.Outlined" Clearable="true" AnchorOrigin="Origin.BottomCenter">
                                <MudSelectItem T="string" Value="@string.Empty">All Classes</MudSelectItem>
                                @foreach (var rc in FilteredRegisterClasses)
                                {
                                    <MudSelectItem T="string" Value="@rc.Id.ToString()">@rc.DisplayName</MudSelectItem>
                                }
                            </MudSelect>
                        </MudItem>
                        <MudItem xs="12" sm="6" md="4">
                            <MudTextField T="string" Label="Search by Name" @bind-Value="_breakSearchTerm"
                                          Variant="Variant.Outlined" Adornment="Adornment.Start"
                                          AdornmentIcon="@Icons.Material.Filled.Search" Immediate="true"
                                          Placeholder="Type name..." />
                        </MudItem>
                        <MudItem xs="12" sm="6" md="2">
                            <MudButton Variant="MudBlazor.Variant.Outlined" Color="Color.Secondary"
                                       FullWidth="true" Style="height: 56px;" OnClick="ClearBreakFilters">
                                Clear Filters
                            </MudButton>
                        </MudItem>
                    </MudGrid>

                    @* Learner Table *@
                    @if (_isLoadingBreakLearners)
                    {
                        <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="mb-2" />
                    }
                    else if (!FilteredBreakLearners.Any())
                    {
                        <MudAlert Severity="Severity.Info">No learners found with the current filters.</MudAlert>
                    }
                    else
                    {
                        <MudTable Items="@FilteredBreakLearners.Take(50)" Dense="true" Hover="true" Striped="true"
                                  FixedHeader="true" Height="400px">
                            <HeaderContent>
                                <MudTh Style="width: 50px;">Select</MudTh>
                                <MudTh>Name</MudTh>
                                <MudTh>Grade</MudTh>
                                <MudTh>Register Class</MudTh>
                                <MudTh>Reason</MudTh>
                            </HeaderContent>
                            <RowTemplate Context="learner">
                                @{
                                    var isSelected = _selectedLearnerIds.Contains(learner.Id);
                                    var breakReason = _learnerBreakReasons.GetValueOrDefault(learner.Id);
                                }
                                <MudTd>
                                    <MudCheckBox T="bool" Value="@isSelected" 
                                                 ValueChanged="@((bool val) => OnBreakLearnerToggle(learner, val))"
                                                 Color="Color.Success" />
                                </MudTd>
                                <MudTd DataLabel="Name">
                                    <MudText Typo="Typo.body2" Style="@(isSelected ? "font-weight: bold; color: var(--mud-palette-success);" : "")">
                                        @learner.DisplayName
                                    </MudText>
                                </MudTd>
                                <MudTd DataLabel="Grade">@learner.RegisterClass?.SchoolGrade?.SystemGrade?.Name</MudTd>
                                <MudTd DataLabel="Register Class">@learner.RegisterClass?.DisplayName</MudTd>
                                <MudTd DataLabel="Reason">
                                    @if (isSelected && !string.IsNullOrEmpty(breakReason))
                                    {
                                        <MudTooltip Text="@breakReason">
                                            <MudChip T="string" Size="Size.Small" Color="Color.Info" Variant="MudBlazor.Variant.Text">
                                                @(breakReason.Length > 30 ? breakReason[..30] + "..." : breakReason)
                                            </MudChip>
                                        </MudTooltip>
                                    }
                                </MudTd>
                            </RowTemplate>
                        </MudTable>
                        @if (FilteredBreakLearners.Count() > 50)
                        {
                            <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mt-2">
                                Showing 50 of @FilteredBreakLearners.Count() learners. Use filters to narrow results.
                            </MudText>
                        }
                    }
                }

                @* Display selected learners *@
                @if (_selectedLearnerIds.Any())
                {
                    <MudDivider Class="my-3" />
                    <MudText Typo="Typo.subtitle2" Class="mt-3 mb-2">
                        Selected Learners (@_selectedLearnerIds.Count)
                    </MudText>
                    <MudChipSet T="string">
                        @foreach (var learnerId in _selectedLearnerIds)
                        {
                            var learner = _allSelectedLearners.FirstOrDefault(l => l.Id == learnerId);
                            if (learner != null)
                            {
                                var isFromGradeSubject = _gradeSubjectLearners.Any(l => l.Id == learnerId);
                                var breakReason = _learnerBreakReasons.GetValueOrDefault(learnerId);
                                <MudChip T="string" Color="@(isFromGradeSubject ? Color.Success : Color.Warning)"
                                         OnClose="@(() => RemoveLearner(learnerId))" Variant="MudBlazor.Variant.Filled"
                                         Style="@(isFromGradeSubject ? "font-weight: bold;" : "")">
                                    @learner.DisplayName
                                    @if (!isFromGradeSubject && _adiModel.AdiType == AdiType.Support)
                                    {
                                        <MudText Typo="Typo.caption" Class="ms-1">(Additional)</MudText>
                                    }
                                    @if (!string.IsNullOrEmpty(breakReason))
                                    {
                                        <MudTooltip Text="@breakReason">
                                            <MudIcon Icon="@Icons.Material.Filled.Info" Size="Size.Small" Class="ms-1" />
                                        </MudTooltip>
                                    }
                                </MudChip>
                            }
                        }
                    </MudChipSet>
                }
            </MudPaper>
        }

        @* Action Buttons *@
        <MudPaper Class="pa-4 mb-4">
            <MudStack Row="true" Spacing="2">
                <MudButton Variant="MudBlazor.Variant.Filled" Color="Color.Primary" 
                           OnClick="HandleValidSubmit" Disabled="@_isLoading">
                    @if (_isLoading)
                    {
                        <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="me-2" />
                        <span>Saving...</span>
                    }
                    else
                    {
                        <MudIcon Icon="@Icons.Material.Filled.Check" Class="me-1" />
                        <span>Create ADI</span>
                    }
                </MudButton>
                <MudButton Variant="MudBlazor.Variant.Outlined" Color="Color.Default" OnClick="Cancel">
                    Cancel
                </MudButton>
            </MudStack>
        </MudPaper>

        @* Recent ADIs *@
        @if (_recentAdis.Any())
        {
            <MudPaper Class="pa-4">
                <MudText Typo="Typo.h6" Class="mb-3">Recent ADIs</MudText>
                <MudTable Items="@_recentAdis.Take(10)" Dense="true" Hover="true" Striped="true">
                    <HeaderContent>
                        <MudTh>Date & Time</MudTh>
                        <MudTh>Type</MudTh>
                        <MudTh>Grade</MudTh>
                        <MudTh>Subjects</MudTh>
                        <MudTh>Teachers</MudTh>
                        <MudTh>Learners</MudTh>
                        <MudTh>Actions</MudTh>
                    </HeaderContent>
                    <RowTemplate Context="adi">
                        <MudTd DataLabel="Date & Time">@adi.DateTime.ToLocalTime().ToString("dd MMM yyyy HH:mm")</MudTd>
                        <MudTd DataLabel="Type">
                            <MudChip T="string" Size="Size.Small" Color="@(adi.AdiType == AdiType.Break ? Color.Warning : Color.Info)">
                                @adi.AdiType.ToString()
                            </MudChip>
                        </MudTd>
                        <MudTd DataLabel="Grade">@(adi.SchoolGrade?.SystemGrade?.Name ?? "Multi-grade")</MudTd>
                        <MudTd DataLabel="Subjects">
                            @if (adi.AdiType == AdiType.Support)
                            {
                                @(adi.Subject?.Name ?? "N/A")
                            }
                            else if (adi.AdiSubjects?.Any() == true)
                            {
                                @string.Join(", ", adi.AdiSubjects.Select(s => s.Subject?.Name ?? "").Where(n => !string.IsNullOrEmpty(n)))
                            }
                            else
                            {
                                <span>None</span>
                            }
                        </MudTd>
                        <MudTd DataLabel="Teachers">
                            @if (adi.AdiType == AdiType.Support)
                            {
                                @(adi.Teacher != null ? $"{adi.Teacher.Surname}, {adi.Teacher.Name}" : "Not assigned")
                            }
                            else if (adi.AdiTeachers?.Any() == true)
                            {
                                @string.Join(", ", adi.AdiTeachers.Select(t => t.Teacher != null ? $"{t.Teacher.Surname}" : "").Where(n => !string.IsNullOrEmpty(n)))
                            }
                            else
                            {
                                <span>Not assigned</span>
                            }
                        </MudTd>
                        <MudTd DataLabel="Learners">@(adi.AdiLearners?.Count ?? 0)</MudTd>
                        <MudTd DataLabel="Actions">
                            <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" Size="Size.Small"
                                           OnClick="@(() => DeleteAdi(adi))" />
                        </MudTd>
                    </RowTemplate>
                </MudTable>
            </MudPaper>
        }
    }
</MudContainer>

@code {
    private School? _selectedSchool;
    private List<SchoolGrade> _schoolGrades = [];
    private List<Subject> _availableSubjects = [];
    private List<User> _availableTeachers = [];
    private List<AcademicDevelopmentClass> _recentAdis = [];
    private List<Learner> _gradeSubjectLearners = [];
    private List<Learner> _allSelectedLearners = [];
    private HashSet<Guid> _selectedLearnerIds = [];
    private Dictionary<Guid, string> _learnerBreakReasons = new();
    private AdiModel _adiModel = new();
    private Dictionary<string, string> _validationErrors = new();
    private bool _isLoading;
    private Guid? _currentUserId;
    private DateTime? _selectedDate = DateTime.Today;
    private TimeSpan? _selectedTime = new TimeSpan(8, 0, 0);
    private MudAutocomplete<Learner>? _learnerAutocomplete;

    // Break ADI specific fields
    private List<Learner> _allSchoolLearners = [];
    private List<RegisterClass> _allRegisterClasses = [];
    private string _breakFilterGradeId = string.Empty;
    private string _breakFilterRegisterClassId = string.Empty;
    private string _breakSearchTerm = string.Empty;
    private bool _isLoadingBreakLearners;
    private HashSet<int> _selectedBreakSubjectIds = [];
    private HashSet<Guid> _selectedBreakTeacherIds = [];

    private IEnumerable<RegisterClass> FilteredRegisterClasses => _allRegisterClasses
        .Where(rc => string.IsNullOrEmpty(_breakFilterGradeId) || rc.SchoolGradeId.ToString() == _breakFilterGradeId)
        .OrderBy(rc => rc.SchoolGrade?.SystemGrade?.SequenceNumber)
        .ThenBy(rc => rc.DisplayName);

    private IEnumerable<Learner> FilteredBreakLearners => _allSchoolLearners
        .Where(l => l.Status == LearnerStatus.Active)
        .Where(l => string.IsNullOrEmpty(_breakFilterGradeId) || l.RegisterClass?.SchoolGradeId.ToString() == _breakFilterGradeId)
        .Where(l => string.IsNullOrEmpty(_breakFilterRegisterClassId) || l.RegisterClassId.ToString() == _breakFilterRegisterClassId)
        .Where(l => string.IsNullOrEmpty(_breakSearchTerm) ||
                    $"{l.DisplayName} {l.Name} {l.Surname}".Contains(_breakSearchTerm.Trim(), StringComparison.OrdinalIgnoreCase))
        .OrderBy(l => l.RegisterClass?.SchoolGrade?.SystemGrade?.SequenceNumber)
        .ThenBy(l => l.Surname)
        .ThenBy(l => l.Name);

    public class AdiModel
    {
        public AdiType AdiType { get; set; } = AdiType.Support;
        public Guid? SchoolGradeId { get; set; }
        public int? SubjectId { get; set; }
        public Guid? TeacherId { get; set; }
    }

    protected override async Task OnInitializedAsync()
    {
        _selectedSchool = await SchoolService.GetSelectedSchoolAsync();
        SubscribeToEvent(UiEvents.SchoolSelected);

        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        if (user.Identity?.IsAuthenticated ?? false)
        {
            var userId = user.FindFirst(ClaimTypes.NameIdentifier)?.Value;
            if (!string.IsNullOrEmpty(userId))
            {
                _currentUserId = Guid.Parse(userId);
                // Default teacher to current user
                _adiModel.TeacherId = _currentUserId;
            }
        }

        if (_selectedSchool != null)
        {
            await LoadData();
        }
    }

    protected override async Task HandleEventAsync(string eventName, object? payload)
    {
        if (eventName == UiEvents.SchoolSelected && payload is School school)
        {
            _selectedSchool = school;
            await LoadData();
            ResetForm();
        }

        await base.HandleEventAsync(eventName, payload);
    }

    private async Task LoadData()
    {
        if (_selectedSchool == null) return;

        try
        {
            _schoolGrades = await SchoolGradeService.GetGradesForSchool(_selectedSchool.Id);
            _availableSubjects = await SubjectService.GetAllAsync();
            _availableTeachers = await UserService.GetBySchoolAsync(_selectedSchool.Id);
            _recentAdis = await AdiService.GetBySchoolIdAsync(_selectedSchool.Id);
            _recentAdis = _recentAdis.OrderByDescending(a => a.DateTime).ToList();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading data for ADI Creator");
            await DialogService.ShowMessageBox("Error", "Failed to load data. Please try again.", yesText: "OK");
        }
        finally
        {
            await InvokeAsync(StateHasChanged);
        }
    }

    private async Task OnGradeChanged(Guid? value)
    {
        _adiModel.SchoolGradeId = value;
        _validationErrors.Remove("Grade");
        await LoadGradeSubjectLearners();
    }

    private async Task OnSubjectChanged(int? value)
    {
        _adiModel.SubjectId = value;
        _validationErrors.Remove("Subject");
        await LoadGradeSubjectLearners();
    }

    private async Task OnAdiTypeChanged(AdiType value)
    {
        _adiModel.AdiType = value;
        
        // Reset grade selection when switching to Break ADI
        if (value == AdiType.Break)
        {
            _adiModel.SchoolGradeId = null;
            _adiModel.SubjectId = null;
            _adiModel.TeacherId = null;
            _gradeSubjectLearners.Clear();
            _selectedLearnerIds.Clear();
            _allSelectedLearners.Clear();
            _learnerBreakReasons.Clear();
            _breakFilterGradeId = string.Empty;
            _breakFilterRegisterClassId = string.Empty;
            _breakSearchTerm = string.Empty;
            _selectedBreakSubjectIds.Clear();
            _selectedBreakTeacherIds.Clear();
            
            // Load all learners for Break ADI
            await LoadBreakAdiLearners();
        }
        else
        {
            // Clear Break ADI data when switching to Support
            _allSchoolLearners.Clear();
            _allRegisterClasses.Clear();
            _selectedBreakSubjectIds.Clear();
            _selectedBreakTeacherIds.Clear();
        }
        
        await InvokeAsync(StateHasChanged);
    }

    private async Task LoadBreakAdiLearners()
    {
        if (_selectedSchool == null) return;

        try
        {
            _isLoadingBreakLearners = true;
            await InvokeAsync(StateHasChanged);

            _allSchoolLearners = await LearnerService.GetBySchoolAsync(_selectedSchool.Id);
            _allSchoolLearners = _allSchoolLearners
                .Where(l => l.Status == LearnerStatus.Active)
                .ToList();

            _allRegisterClasses = _allSchoolLearners
                .Where(l => l.RegisterClass != null)
                .Select(l => l.RegisterClass!)
                .DistinctBy(rc => rc.Id)
                .OrderBy(rc => rc.SchoolGrade?.SystemGrade?.SequenceNumber)
                .ThenBy(rc => rc.DisplayName)
                .ToList();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading learners for Break ADI");
        }
        finally
        {
            _isLoadingBreakLearners = false;
            await InvokeAsync(StateHasChanged);
        }
    }

    private void ClearBreakFilters()
    {
        _breakFilterGradeId = string.Empty;
        _breakFilterRegisterClassId = string.Empty;
        _breakSearchTerm = string.Empty;
    }

    private async Task OnBreakLearnerToggle(Learner learner, bool isSelected)
    {
        if (isSelected)
        {
            // Adding learner - prompt for reason
            var reason = await ShowBreakReasonDialogAsync(learner);
            if (string.IsNullOrWhiteSpace(reason))
            {
                // User cancelled
                return;
            }
            
            _learnerBreakReasons[learner.Id] = reason;
            _selectedLearnerIds.Add(learner.Id);
            _allSelectedLearners.Insert(0, learner);
        }
        else
        {
            // Removing learner
            _selectedLearnerIds.Remove(learner.Id);
            _learnerBreakReasons.Remove(learner.Id);
            _allSelectedLearners.RemoveAll(l => l.Id == learner.Id);
        }
        
        await InvokeAsync(StateHasChanged);
    }

    private void OnTeacherChanged(Guid? value)
    {
        _adiModel.TeacherId = value;
    }

    private void ToggleBreakSubject(int subjectId)
    {
        if (_selectedBreakSubjectIds.Contains(subjectId))
        {
            _selectedBreakSubjectIds.Remove(subjectId);
        }
        else
        {
            _selectedBreakSubjectIds.Add(subjectId);
        }
        _validationErrors.Remove("Subjects");
    }

    private void ToggleBreakTeacher(Guid teacherId)
    {
        if (_selectedBreakTeacherIds.Contains(teacherId))
        {
            _selectedBreakTeacherIds.Remove(teacherId);
        }
        else
        {
            _selectedBreakTeacherIds.Add(teacherId);
        }
        _validationErrors.Remove("Teachers");
    }

    private async Task LoadGradeSubjectLearners()
    {
        // For Break ADI, we don't auto-load learners based on grade/subject
        if (_adiModel.AdiType == AdiType.Break)
        {
            _gradeSubjectLearners = [];
            return;
        }

        if (_adiModel.SchoolGradeId == null || _adiModel.SubjectId == null)
        {
            _gradeSubjectLearners = [];
            return;
        }

        try
        {
            _gradeSubjectLearners = await LearnerService.GetByGradeAndSubjectAsync(
                _adiModel.SchoolGradeId.Value, 
                _adiModel.SubjectId.Value);

            // Filter to current school
            _gradeSubjectLearners = _gradeSubjectLearners
                .Where(l => l.SchoolId == _selectedSchool?.Id && l.Status == LearnerStatus.Active)
                .OrderBy(l => l.Surname)
                .ThenBy(l => l.Name)
                .ToList();

            // Auto-select all grade/subject learners
            foreach (var learner in _gradeSubjectLearners)
            {
                if (!_selectedLearnerIds.Contains(learner.Id))
                {
                    _selectedLearnerIds.Add(learner.Id);
                    _allSelectedLearners.Add(learner);
                }
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading grade/subject learners");
        }

        await InvokeAsync(StateHasChanged);
    }

    private void ToggleLearner(Guid learnerId)
    {
        if (_selectedLearnerIds.Contains(learnerId))
        {
            _selectedLearnerIds.Remove(learnerId);
        }
        else
        {
            _selectedLearnerIds.Add(learnerId);
            var learner = _gradeSubjectLearners.FirstOrDefault(l => l.Id == learnerId);
            if (learner != null && !_allSelectedLearners.Any(l => l.Id == learnerId))
            {
                _allSelectedLearners.Add(learner);
            }
        }
    }

    private void RemoveLearner(Guid learnerId)
    {
        _selectedLearnerIds.Remove(learnerId);
    }

    private void SelectAllGradeSubjectLearners()
    {
        foreach (var learner in _gradeSubjectLearners)
        {
            if (!_selectedLearnerIds.Contains(learner.Id))
            {
                _selectedLearnerIds.Add(learner.Id);
                if (!_allSelectedLearners.Any(l => l.Id == learner.Id))
                {
                    _allSelectedLearners.Add(learner);
                }
            }
        }
    }

    private void DeselectAllGradeSubjectLearners()
    {
        foreach (var learner in _gradeSubjectLearners)
        {
            _selectedLearnerIds.Remove(learner.Id);
        }
    }

    private async Task<IEnumerable<Learner>> SearchLearnersAsync(string searchText, CancellationToken ct)
    {
        if (string.IsNullOrWhiteSpace(searchText) || _selectedSchool == null)
            return [];

        try
        {
            var results = await LearnerService.SearchLearnersAsync(_selectedSchool.Id, searchText);
            return results
                .Where(l => l.Status == LearnerStatus.Active && !_selectedLearnerIds.Contains(l.Id))
                .Take(20);
        }
        catch
        {
            return [];
        }
    }

    private async Task OnAdditionalLearnerSelected(Learner? learner)
    {
        if (learner == null) return;

        if (_selectedLearnerIds.Contains(learner.Id))
            return;

        // For Break ADI, require a reason
        if (_adiModel.AdiType == AdiType.Break)
        {
            var reason = await ShowBreakReasonDialogAsync(learner);
            if (string.IsNullOrWhiteSpace(reason))
            {
                // User cancelled or didn't provide a reason
                return;
            }
            _learnerBreakReasons[learner.Id] = reason;
        }

        _selectedLearnerIds.Add(learner.Id);
        // Add to the beginning of the list so new learners appear at the top
        _allSelectedLearners.Insert(0, learner);
        
        // Clear the autocomplete selection
        if (_learnerAutocomplete != null)
        {
            await _learnerAutocomplete.ClearAsync();
        }
        
        await InvokeAsync(StateHasChanged);
    }

    private async Task<string?> ShowBreakReasonDialogAsync(Learner learner)
    {
        var parameters = new DialogParameters<BreakReasonDialog>
        {
            { x => x.LearnerName, learner.DisplayName }
        };

        var options = new DialogOptions { CloseOnEscapeKey = true, MaxWidth = MaxWidth.Small, FullWidth = true };
        var dialog = await DialogService.ShowAsync<BreakReasonDialog>("Break ADI Reason", parameters, options);
        var result = await dialog.Result;

        if (result != null && !result.Canceled && result.Data is string reason)
        {
            return reason;
        }
        return null;
    }

    private bool ValidateForm()
    {
        _validationErrors.Clear();

        // Grade is only required for Support ADI
        if (_adiModel.AdiType == AdiType.Support && _adiModel.SchoolGradeId == null)
            _validationErrors["Grade"] = "Please select a grade.";

        // Subject validation differs by ADI type
        if (_adiModel.AdiType == AdiType.Support && _adiModel.SubjectId == null)
            _validationErrors["Subject"] = "Please select a subject.";
        
        if (_adiModel.AdiType == AdiType.Break && !_selectedBreakSubjectIds.Any())
            _validationErrors["Subjects"] = "Please select at least one subject.";

        if (_selectedDate == null)
            _validationErrors["DateTime"] = "Please select a date.";

        if (!_selectedLearnerIds.Any())
            _validationErrors["Learners"] = "Please select at least one learner.";

        return !_validationErrors.Any();
    }

    private async Task HandleValidSubmit()
    {
        if (!ValidateForm())
        {
            if (_validationErrors.ContainsKey("Learners"))
            {
                await DialogService.ShowMessageBox("Validation Error", _validationErrors["Learners"], yesText: "OK");
            }
            return;
        }

        _isLoading = true;
        await InvokeAsync(StateHasChanged);

        try
        {
            var dateTime = _selectedDate!.Value.Date;
            if (_selectedTime.HasValue)
            {
                dateTime = dateTime.Add(_selectedTime.Value);
            }
            dateTime = DateTime.SpecifyKind(dateTime, DateTimeKind.Utc);

            var adi = new AcademicDevelopmentClass
            {
                DateTime = dateTime,
                AdiType = _adiModel.AdiType,
                SchoolGradeId = _adiModel.AdiType == AdiType.Support ? _adiModel.SchoolGradeId : null,
                SubjectId = _adiModel.AdiType == AdiType.Support ? _adiModel.SubjectId : null,
                TeacherId = _adiModel.AdiType == AdiType.Support ? _adiModel.TeacherId : null,
                SchoolId = _selectedSchool!.Id,
                CreatedBy = _currentUserId
            };

            // For Break ADI, populate the multi-select collections
            if (_adiModel.AdiType == AdiType.Break)
            {
                foreach (var subjectId in _selectedBreakSubjectIds)
                {
                    adi.AdiSubjects.Add(new AdiSubject { SubjectId = subjectId });
                }
                foreach (var teacherId in _selectedBreakTeacherIds)
                {
                    adi.AdiTeachers.Add(new AdiTeacher { TeacherId = teacherId });
                }
            }

            var createdAdi = await AdiService.CreateAsync(adi);

            // Add selected learners to the ADI, marking which are additional
            var gradeSubjectLearnerIds = _gradeSubjectLearners.Select(l => l.Id).ToHashSet();
            
            // Add non-additional learners first (Support ADI only)
            var regularLearnerIds = _selectedLearnerIds.Where(id => gradeSubjectLearnerIds.Contains(id)).ToList();
            await AdiAttendanceService.AddLearnersToAdiAsync(createdAdi.Id, regularLearnerIds, _currentUserId);

            // Add additional learners (those not from grade/subject, or all learners for Break ADI)
            foreach (var learnerId in _selectedLearnerIds.Where(id => !gradeSubjectLearnerIds.Contains(id)))
            {
                var breakReason = _learnerBreakReasons.GetValueOrDefault(learnerId);
                await AdiAttendanceService.AddAdditionalLearnerAsync(
                    createdAdi.Id, 
                    learnerId, 
                    _currentUserId,
                    breakReason);
            }

            var learnerCount = _selectedLearnerIds.Count;
            Logger.LogInformation("Created ADI {AdiId} with {LearnerCount} learners", createdAdi.Id, learnerCount);

            ResetForm();
            await LoadData();

            await DialogService.ShowMessageBox(
                "Success",
                $"ADI has been created successfully with {learnerCount} learners!",
                yesText: "OK");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error creating ADI");
            await DialogService.ShowMessageBox("Error", "Failed to create ADI. Please try again.", yesText: "OK");
        }
        finally
        {
            _isLoading = false;
            await InvokeAsync(StateHasChanged);
        }
    }

    private void ResetForm()
    {
        _adiModel = new AdiModel { TeacherId = _currentUserId };
        _selectedDate = DateTime.Today;
        _selectedTime = new TimeSpan(8, 0, 0);
        _selectedLearnerIds.Clear();
        _allSelectedLearners.Clear();
        _gradeSubjectLearners.Clear();
        _learnerBreakReasons.Clear();
        _validationErrors.Clear();
        // Clear Break ADI data
        _allSchoolLearners.Clear();
        _allRegisterClasses.Clear();
        _breakFilterGradeId = string.Empty;
        _breakFilterRegisterClassId = string.Empty;
        _breakSearchTerm = string.Empty;
        _selectedBreakSubjectIds.Clear();
        _selectedBreakTeacherIds.Clear();
    }

    private async Task DeleteAdi(AcademicDevelopmentClass adi)
    {
        var result = await DialogService.ShowMessageBox(
            "Confirm Delete",
            $"Are you sure you want to delete this ADI scheduled for {adi.DateTime.ToLocalTime():dd MMM yyyy HH:mm}?",
            yesText: "Delete",
            cancelText: "Cancel");

        if (result == true)
        {
            try
            {
                await AdiService.DeleteAsync(adi.Id);
                await LoadData();
                Logger.LogInformation("Deleted ADI {AdiId}", adi.Id);
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "Error deleting ADI {AdiId}", adi.Id);
                await DialogService.ShowMessageBox("Error", "Failed to delete ADI. Please try again.", yesText: "OK");
            }
        }
    }

    private void Cancel()
    {
        Navigation.NavigateTo("/");
    }
}
