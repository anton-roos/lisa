@page "/schools"
@using Lisa.Models.Entities
@inject NavigationManager NavigationManager
@inject SchoolService SchoolService
@inject IDialogService DialogService

<AuthorizeView Roles="@Roles.SystemAdministrator">
    <Authorized>
        <MudButton Variant="Variant.Filled" 
                   Color="Color.Primary" 
                   StartIcon="@Icons.Material.Filled.Add"
                   OnClick="AddSchool"
                   Class="mb-3">
            Add School
        </MudButton>

        @if (_schools == null)
        {
            <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="my-4" />
        }
        else if (_schools.Count == 0)
        {
            <MudAlert Severity="Severity.Info" Class="mt-3">
                No Schools found, please add a School.
            </MudAlert>
        }
        else
        {
            <MudTable Items="@_schools" 
                      Hover="true" 
                      Striped="true" 
                      Dense="true"
                      Elevation="2">
                <HeaderContent>
                    <MudTh>Short Name</MudTh>
                    <MudTh>Long Name</MudTh>
                    <MudTh>Academic Year</MudTh>
                    <MudTh>Color</MudTh>
                    <MudTh>Actions</MudTh>
                </HeaderContent>
                <RowTemplate Context="school">
                    <MudTd DataLabel="Short Name">@school.ShortName</MudTd>
                    <MudTd DataLabel="Long Name">@school.LongName</MudTd>
                    <MudTd DataLabel="Academic Year">
                        @if (_academicYears.TryGetValue(school.Id, out var year))
                        {
                            <MudChip T="string" Size="Size.Small" Color="Color.Info">@year</MudChip>
                        }
                        else
                        {
                            <MudText Typo="Typo.body2" Color="Color.Secondary">Not Set</MudText>
                        }
                    </MudTd>
                    <MudTd DataLabel="Color">
                        <div class="d-flex align-items-center gap-2">
                            <div class="color-box" style="background-color:@school.Color;"></div>
                            @school.Color
                        </div>
                    </MudTd>
                    <MudTd DataLabel="Actions">
                        <MudIconButton Icon="@Icons.Material.Filled.Visibility" 
                                       Color="Color.Primary" 
                                       Size="Size.Small"
                                       OnClick="@(() => ViewSchool(school))"
                                       title="View" />
                        <MudIconButton Icon="@Icons.Material.Filled.Edit" 
                                       Color="Color.Secondary" 
                                       Size="Size.Small"
                                       OnClick="@(() => EditSchool(school))"
                                       title="Edit" />
                        <MudIconButton Icon="@Icons.Material.Filled.Delete" 
                                       Color="Color.Error" 
                                       Size="Size.Small"
                                       OnClick="@(() => DeleteSchool(school))"
                                       title="Delete" />
                    </MudTd>
                </RowTemplate>
            </MudTable>
        }
    </Authorized>
    <NotAuthorized>
        <Unauthorized />
    </NotAuthorized>
</AuthorizeView>

@code {
    private List<School>? _schools;
    private List<SchoolType> _schoolTypes = [];
    private List<SchoolCurriculum> _curriculums = [];
    private Dictionary<Guid, int> _academicYears = new();

    protected override async Task OnInitializedAsync()
    {
        _schools = await SchoolService.GetAllAsync();
        _schoolTypes = await SchoolService.GetSchoolTypesAsync();
        _curriculums = await SchoolService.GetSchoolCurriculumsAsync();
        await LoadAcademicYears();
    }

    private async Task LoadAcademicYears()
    {
        if (_schools == null) return;
        
        foreach (var school in _schools)
        {
            var currentYear = await SchoolService.GetCurrentAcademicYearAsync(school.Id);
            if (currentYear != null)
            {
                _academicYears[school.Id] = currentYear.Year;
            }
        }
    }

    private async Task EditSchool(School school)
    {
        var parameters = new DialogParameters<SchoolFormDialog>
        {
            { x => x.School, school },
            { x => x.SchoolTypes, _schoolTypes },
            { x => x.Curriculums, _curriculums },
            { x => x.IsEdit, true }
        };

        var options = new DialogOptions { MaxWidth = MaxWidth.Medium, FullWidth = true, CloseButton = true };
        var dialog = await DialogService.ShowAsync<SchoolFormDialog>("Edit School", parameters, options);
        var result = await dialog.Result;

        if (result is { Canceled: false })
        {
            _schools = await SchoolService.GetAllAsync();
            await LoadAcademicYears();
        }
    }

    private async Task ViewSchool(School school)
    {
        var parameters = new DialogParameters<SchoolDetailsDialog>
        {
            { x => x.School, school }
        };

        var options = new DialogOptions { MaxWidth = MaxWidth.Medium, FullWidth = true, CloseButton = true };
        var dialog = await DialogService.ShowAsync<SchoolDetailsDialog>("School Details", parameters, options);
        var result = await dialog.Result;

        if (result is { Canceled: false, Data: "yearend" })
        {
            NavigationManager.NavigateTo($"/schools/yearend/{school.Id}");
        }
    }

    private async Task DeleteSchool(School school)
    {
        var parameters = new DialogParameters<SchoolDeleteDialog>
        {
            { x => x.School, school }
        };

        var options = new DialogOptions { MaxWidth = MaxWidth.Small, CloseButton = true };
        var dialog = await DialogService.ShowAsync<SchoolDeleteDialog>("Delete School", parameters, options);
        var result = await dialog.Result;

        if (result is { Canceled: false })
        {
            await LoadAcademicYears();
            _schools = await SchoolService.GetAllAsync();
        }
    }

    private async Task AddSchool()
    {
        var parameters = new DialogParameters<SchoolFormDialog>
        {
            { x => x.School, new School() },
            { x => x.SchoolTypes, _schoolTypes },
            { x => x.Curriculums, _curriculums },
            { x => x.IsEdit, false }
        };

        var options = new DialogOptions { MaxWidth = MaxWidth.Medium, FullWidth = true, CloseButton = true };
        var dialog = await DialogService.ShowAsync<SchoolFormDialog>("Add School", parameters, options);
        var result = await dialog.Result;

        if (result is { Canceled: false })
        {
            await LoadAcademicYears();
            _schools = await SchoolService.GetAllAsync();
        }
    }
}
